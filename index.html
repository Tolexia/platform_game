<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./exitdoor.js"></script>
    <script src="./platform.js"></script>
    <script src="./levels.js"></script>
</head>
<style>
    *{
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    body{
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100lvw;
        height: 100dvh;
        overflow: hidden;
    }
    canvas{
        border: 1px solid black;
    }
    #instructions{
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50lvw;
        height: 50dvh;
        text-align: center;
        opacity: .7;
        font-family: Arial, Helvetica, sans-serif;
    }
</style>
<body>
    <div id = "instructions"></div>
    <canvas id="canvas" ></canvas>
</body>
<script>
    var canvas = document.getElementById('canvas')
    var instructions = document.getElementById('instructions')
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    let raf;

    const coord_x_start = win_width*0.1
    const coord_y_start = win_height*0.9

    const ball = {
        x: coord_x_start,
        y: coord_y_start,
        vx: 2,
        vy: 2,
        radius: 5,
        color: "blue",
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
          ctx.closePath();
          ctx.fillStyle = this.color;
          ctx.fill();
        },
    };

    

    var platforms = []
    var exit 
    var currentLevel = localStorage.getItem('current_level') != null ? + localStorage.getItem('current_level') : 0;
    var maxjump 

    function setMaxJump()
    {
        maxjump = currentLevel > 2 ? 2 : 1
    }
    function launchLevel()
    {
        ball.x = coord_x_start
        ball.Y = coord_y_start
        instructions.innerHTML = ""
        if(window["level"+currentLevel])
        {
            window["level"+currentLevel]()
        }
        else
        {
            alert("Game Over.\n Congrats !")
            localStorage.setItem("current_level", 0)
            currentLevel = 0
            level0()
        }
        setMaxJump()
    }

    launchLevel()
    

    var hasWon = false;
    function checkHasWon()
    {
        
        return (
            ball.x+ball.radius >= exit.x_start && 
            ball.x <= exit.x_end-ball.radius && 
            ball.y+ball.radius >= exit.y_start && 
            ball.y <= exit.y_end-ball.radius
        )
    }
    function draw() 
    {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        exit.draw()
        
        if(!hasWon)
            ball.draw();

        let blockX = false
        let blockY = false
        for(const line of platforms)
        {
            line.draw()
            if(
                ball.x + ball.vx >= line.x_start - ball.radius && 
                ball.x + ball.vx <= line.x_end + ball.radius
            )
            {
                const onFloor = (ball.y + ball.vy  >= line.y_start - ball.radius) && (ball.y + ball.vy <= line.y_end)
                const underneathFloor = (ball.y + ball.vy <= line.y_end + ball.radius) && (ball.y + ball.vy  >= line.y_start) 
                if(
                    onFloor || underneathFloor
                )
                {
                    blockY = true
                    if(onFloor) jumpcount = 0
                }
            }
        }
        
        // Y
        if(blockY && !pressingUp)
        {
            ball.vy = 0
        }
        else if ( ball.y + ball.vy >= canvas.height - ball.radius  ) 
        {
            ball.vy = 0;
            jumpcount = 0;
        }
        else if (ball.y + ball.vy < ball.radius) {
            ball.vy = -ball.vy;
        }

        // X
        if (
            ball.x + ball.vx >= canvas.width - ball.radius ||
            ball.x + ball.vx <= ball.radius
        ) {
            ball.vx = 0;
        }

        ball.x += ball.vx;
        ball.y += ball.vy;

        ball.vy *= 0.99;
        ball.vy += 0.25;

        ball.vx *= 0.99
        
        hasWon = checkHasWon()
        if(hasWon)
        {
            currentLevel++
            localStorage.setItem("current_level", currentLevel)
            launchLevel()
            hasWon = false
        }
        
        raf = window.requestAnimationFrame(draw);
    }

    let jumpcount = 0

    let pressingUp = false
    let pressingDown = false
    let pressingLeft = false
    let pressingRight = false
    document.body.addEventListener("keydown", e => {
        console.log("jumpcount", jumpcount)
        if(e.key == "ArrowUp" && jumpcount < maxjump)
        {
            ball.vy = -10
            jumpcount++
        }
        if(e.key == "ArrowLeft")
        {
            pressingLeft = true 
            left()
        }
        if(e.key == "ArrowRight")
        {
            pressingRight = true 
            right()
        }
    })
    function up(){
        console.log(ball.vy)
        if(ball.vy > -10) ball.vy -= 1
        if(pressingUp == true)window.requestAnimationFrame(up)
    }
    function left(){
        if(ball.vx > -5) ball.vx -= 0.25
        if(pressingLeft == true)window.requestAnimationFrame(left)
    }
    function right(){
        if(ball.vx < 5) ball.vx += 0.5
        if(pressingRight == true)window.requestAnimationFrame(right)
    }
    document.body.addEventListener("keyup", e => {
        if(e.key == "ArrowLeft")
            pressingLeft = false 
        if(e.key == "ArrowRight")
            pressingRight = false 
    })
    
    
    draw()
</script>
</html>